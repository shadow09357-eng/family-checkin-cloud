<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>å®¶åº­æ‰“å¡æé†’</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            padding-top: max(12px, env(safe-area-inset-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .app-header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        /* ç™»å½•é¡µé¢ */
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn, .register-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }

        .login-btn {
            background: #667eea;
            color: white;
        }

        .login-btn:hover {
            background: #5a6fd8;
        }

        .register-btn {
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .register-btn:hover {
            background: #667eea;
            color: white;
        }

        .error-message, .success-message {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            white-space: pre-line;
            line-height: 1.4;
        }

        .error-message {
            color: #e74c3c;
        }

        .success-message {
            color: #27ae60;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .page {
            display: none;
            height: 100%;
        }

        .page.active {
            display: block;
        }

        .tab-content {
            display: none;
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* è¡¨å•æ ·å¼ */
        .form-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-container h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .primary-btn {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .primary-btn:hover {
            background: #5a6fd8;
        }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .task-list-container h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .task-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .task-item h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
        }

        .task-item p {
            margin: 0 0 8px 0;
            color: #666;
            font-size: 14px;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #999;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-checkin {
            background: #27ae60;
            color: white;
        }

        /* åº•éƒ¨å¯¼èˆª */
        .footer-nav {
            display: flex;
            background: white;
            border-top: 1px solid #e1e5e9;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .footer-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: none;
            border: none;
            color: #999;
            font-size: 12px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .footer-item.active {
            color: #667eea;
        }

        .footer-item-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .login-box {
                padding: 20px;
                margin: 10px;
            }
            
            .login-title {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2 class="login-title">å®¶åº­æ‰“å¡æé†’</h2>
            
            <!-- è´¦æˆ·è®¾ç½® -->
            <div id="setupForm">
                <div class="form-group">
                    <label for="adminName">ç®¡ç†å‘˜å§“å</label>
                    <input type="text" id="adminName" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å§“å" required>
                </div>
                <div class="form-group">
                    <label for="memberName">æˆå‘˜å§“å</label>
                    <input type="text" id="memberName" placeholder="è¯·è¾“å…¥æˆå‘˜å§“å" required>
                </div>
                <button id="setupBtn" class="login-btn">åˆ›å»ºè´¦æˆ·</button>
                <div id="setupMessage"></div>
            </div>

            <!-- ç™»å½•è¡¨å• -->
            <div id="loginForm" class="hidden">
                <div class="form-group">
                    <label for="userSelect">é€‰æ‹©ç”¨æˆ·</label>
                    <select id="userSelect">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                    </select>
                </div>
                <button id="loginBtn" class="login-btn">ç™»å½•</button>
                <button id="resetBtn" class="register-btn">é‡æ–°è®¾ç½®è´¦æˆ·</button>
                <div id="loginMessage"></div>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div id="mainApp" class="app-container hidden">
        <div class="app-header">
            <h1>å®¶åº­æ‰“å¡æé†’</h1>
            <div class="user-info">
                <span id="currentUserName"></span>
                <button id="logoutBtn" class="logout-btn">é€€å‡º</button>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- ç®¡ç†å‘˜é¡µé¢ -->
            <div id="adminPage" class="page">
                <!-- æ–°å»ºä»»åŠ¡ -->
                <div id="adminCreateTab" class="tab-content active">
                    <div class="form-container">
                        <h3>æ–°å»ºä»»åŠ¡</h3>
                        <div class="form-group">
                            <label>ä»»åŠ¡æ ‡é¢˜</label>
                            <input type="text" id="taskTitle" placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜">
                        </div>
                        <div class="form-group">
                            <label>ä»»åŠ¡æè¿°</label>
                            <textarea id="taskDescription" placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="taskStartDate">
                        </div>
                        <div class="form-group">
                            <label>ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="taskEndDate">
                        </div>
                        <div class="form-group">
                            <label>é‡å¤å‘¨æœŸ</label>
                            <select id="taskCycle" onchange="toggleCustomDays()">
                                <option value="daily">æ¯å¤©</option>
                                <option value="weekly">æ¯å‘¨</option>
                                <option value="custom">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                        <div class="form-group" id="customDaysGroup" style="display: none;">
                            <label>è‡ªå®šä¹‰å¤©æ•°</label>
                            <input type="number" id="customDays" min="1" placeholder="é—´éš”å¤©æ•°">
                        </div>
                        <div class="form-group">
                            <label>ç›®æ ‡æ—¶é—´</label>
                            <input type="time" id="expectedTime">
                        </div>
                        <div class="form-group">
                            <label>å…è®¸æµ®åŠ¨æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" id="timeRange" min="0" placeholder="Â±åˆ†é’Ÿæ•°" value="30">
                        </div>
                        <button class="primary-btn" onclick="createTask()">åˆ›å»ºä»»åŠ¡</button>
                    </div>
                </div>

                <!-- ä»»åŠ¡ç®¡ç† -->
                <div id="adminManageTab" class="tab-content">
                    <div class="task-list-container">
                        <h3>ä»»åŠ¡ç®¡ç†</h3>
                        <div id="taskList"></div>
                    </div>
                </div>
            </div>

            <!-- æˆå‘˜é¡µé¢ -->
            <div id="memberPage" class="page">
                <!-- ä»Šæ—¥ä»»åŠ¡ -->
                <div id="memberTaskTab" class="tab-content active">
                    <div class="task-list-container">
                        <h3>ä»Šæ—¥ä»»åŠ¡</h3>
                        <div id="todayTasks"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <div id="footerNav" class="footer-nav">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨
        const store = {
            users: [],
            tasks: [],
            checkins: [],
            currentUser: null,
            accounts: null
        };

        // è·å–æœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
        function getLocalDateStr(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('åº”ç”¨å¼€å§‹åˆå§‹åŒ–...');
            initData();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('setupBtn').addEventListener('click', setupAccounts);
            document.getElementById('loginBtn').addEventListener('click', quickLogin);
            document.getElementById('resetBtn').addEventListener('click', resetAccounts);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            const today = new Date();
            document.getElementById('taskStartDate').value = getLocalDateStr(today);
            document.getElementById('taskEndDate').value = getLocalDateStr(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000));
        });

        function initData() {
            const saved = localStorage.getItem('familyCheckinData');
            if (saved) {
                const data = JSON.parse(saved);
                store.users = data.users || [];
                store.tasks = data.tasks || [];
                store.checkins = data.checkins || [];
                store.currentUser = data.currentUser;
                store.accounts = data.accounts;
            }
            
            const accounts = localStorage.getItem('familyCheckinAccounts');
            if (accounts) {
                store.accounts = JSON.parse(accounts);
                showLoginMode();
            } else {
                showSetupMode();
            }
        }

        function saveData() {
            localStorage.setItem('familyCheckinData', JSON.stringify(store));
        }

        function showSetupMode() {
            document.getElementById('setupForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
        }

        function showLoginMode() {
            document.getElementById('setupForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            
            if (store.accounts) {
                select.innerHTML += `<option value="admin">${store.accounts.adminName} (ç®¡ç†å‘˜)</option>`;
                select.innerHTML += `<option value="member">${store.accounts.memberName} (æˆå‘˜)</option>`;
            }
        }

        function setupAccounts() {
            const adminName = document.getElementById('adminName').value.trim();
            const memberName = document.getElementById('memberName').value.trim();

            if (!adminName || !memberName) {
                showSetupMessage('è¯·è¾“å…¥ç®¡ç†å‘˜å’Œæˆå‘˜çš„åå­—', 'error');
                return;
            }

            if (adminName === memberName) {
                showSetupMessage('ç®¡ç†å‘˜å’Œæˆå‘˜çš„åå­—ä¸èƒ½ç›¸åŒ', 'error');
                return;
            }

            store.accounts = { adminName, memberName };
            localStorage.setItem('familyCheckinAccounts', JSON.stringify(store.accounts));
            
            store.users = [
                { id: 1, name: adminName, role: 'admin' },
                { id: 2, name: memberName, role: 'member' }
            ];
            saveData();
            
            showLoginMode();
            showSetupMessage('è´¦æˆ·è®¾ç½®æˆåŠŸï¼', 'success');
        }

        function quickLogin() {
            const role = document.getElementById('userSelect').value;

            if (!role) {
                showLoginMessage('è¯·é€‰æ‹©è´¦æˆ·', 'error');
                return;
            }

            const user = store.users.find(u => u.role === role);
            store.currentUser = user;
            
            document.getElementById('currentUserName').textContent = user.name;
            
            showPage(role === 'admin' ? 'adminPage' : 'memberPage');
            showMainApp();
            
            if (role === 'admin') {
                setupAdminNav();
                switchAdminTab('create');
            } else {
                setupMemberNav();
                switchMemberTab('task');
            }
        }

        function resetAccounts() {
            if (confirm('ç¡®å®šè¦é‡æ–°è®¾ç½®è´¦æˆ·å—ï¼Ÿè¿™ä¼šæ¸…é™¤æ‰€æœ‰æ•°æ®ã€‚')) {
                localStorage.removeItem('familyCheckinAccounts');
                localStorage.removeItem('familyCheckinData');
                store.users = [];
                store.tasks = [];
                store.checkins = [];
                store.currentUser = null;
                store.accounts = null;
                showSetupMode();
            }
        }

        function logout() {
            store.currentUser = null;
            showLoginContainer();
            document.getElementById('currentUserName').textContent = '';
        }

        function showLoginContainer() {
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function setupAdminNav() {
            const footerNav = document.getElementById('footerNav');
            footerNav.innerHTML = `
                <button class="footer-item active" onclick="switchFooterTab('tab1')">
                    <div class="footer-item-icon">â•</div>
                    <div>æ–°å»º</div>
                </button>
                <button class="footer-item" onclick="switchFooterTab('tab2')">
                    <div class="footer-item-icon">ğŸ“‹</div>
                    <div>ç®¡ç†</div>
                </button>
            `;
        }

        function setupMemberNav() {
            const footerNav = document.getElementById('footerNav');
            footerNav.innerHTML = `
                <button class="footer-item active" onclick="switchFooterTab('tab1')">
                    <div class="footer-item-icon">ğŸ“‹</div>
                    <div>ä»»åŠ¡</div>
                </button>
            `;
        }

        function switchFooterTab(tab) {
            const footerItems = document.querySelectorAll('.footer-item');
            footerItems.forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (store.currentUser.role === 'admin') {
                if (tab === 'tab1') {
                    switchAdminTab('create');
                } else if (tab === 'tab2') {
                    switchAdminTab('manage');
                }
            } else {
                if (tab === 'tab1') {
                    switchMemberTab('task');
                }
            }
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('#adminPage .tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'create') {
                document.getElementById('adminCreateTab').classList.add('active');
            } else if (tab === 'manage') {
                document.getElementById('adminManageTab').classList.add('active');
                loadTaskList();
            }
        }

        function switchMemberTab(tab) {
            document.querySelectorAll('#memberPage .tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'task') {
                document.getElementById('memberTaskTab').classList.add('active');
                loadTodayTasks();
            }
        }

        function toggleCustomDays() {
            const cycle = document.getElementById('taskCycle').value;
            const customDaysGroup = document.getElementById('customDaysGroup');
            customDaysGroup.style.display = cycle === 'custom' ? 'block' : 'none';
        }

        function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const startDate = document.getElementById('taskStartDate').value;
            const endDate = document.getElementById('taskEndDate').value;
            const cycle = document.getElementById('taskCycle').value;
            const customDays = document.getElementById('customDays').value;
            const expectedTime = document.getElementById('expectedTime').value;
            const timeRange = parseInt(document.getElementById('timeRange').value) || 30;

            if (!title || !startDate || !endDate || !expectedTime) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }

            if (cycle === 'custom' && (!customDays || customDays < 1)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è‡ªå®šä¹‰å¤©æ•°');
                return;
            }

            const taskData = {
                id: Date.now().toString(),
                title,
                description,
                startDate,
                endDate,
                cycle,
                customDays: cycle === 'custom' ? parseInt(customDays) : null,
                expectedTime,
                timeRange,
                createdBy: store.currentUser.id,
                createdAt: Date.now(),
                isActive: true
            };

            store.tasks.push(taskData);
            saveData();

            alert('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼');
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('customDays').value = '';
        }

        function loadTaskList() {
            const tasks = store.tasks.filter(task => task.isActive);
            renderTaskList(tasks.reverse());
        }

        function renderTaskList(tasks) {
            const taskList = document.getElementById('taskList');
            
            if (tasks.length === 0) {
                taskList.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">æš‚æ— ä»»åŠ¡</div>';
                return;
            }

            taskList.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <h4>${task.title}</h4>
                    <p>${task.description}</p>
                    <div class="task-meta">
                        <span>${task.startDate} è‡³ ${task.endDate}</span>
                        <span>${task.expectedTime} (Â±${task.timeRange}åˆ†é’Ÿ)</span>
                    </div>
                    <div class="task-actions">
                        <button class="btn-small btn-delete" onclick="deleteTask('${task.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function loadTodayTasks() {
            const today = getLocalDateStr();
            const todayTasks = store.tasks.filter(task => 
                task.isActive && isTaskActiveOnDate(task, today)
            );
            renderTodayTasks(todayTasks);
        }

        function isTaskActiveOnDate(task, dateStr) {
            const date = new Date(dateStr);
            const startDate = new Date(task.startDate);
            const endDate = new Date(task.endDate);
            
            if (date < startDate || date > endDate) {
                return false;
            }
            
            if (task.cycle === 'daily') {
                return true;
            } else if (task.cycle === 'weekly') {
                const daysDiff = Math.floor((date - startDate) / (24 * 60 * 60 * 1000));
                return daysDiff % 7 === 0;
            } else if (task.cycle === 'custom') {
                const daysDiff = Math.floor((date - startDate) / (24 * 60 * 60 * 1000));
                return daysDiff % task.customDays === 0;
            }
            
            return false;
        }

        function renderTodayTasks(tasks) {
            const todayTasks = document.getElementById('todayTasks');
            
            if (tasks.length === 0) {
                todayTasks.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">ä»Šæ—¥æ— ä»»åŠ¡</div>';
                return;
            }

            const today = getLocalDateStr();
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            todayTasks.innerHTML = tasks.map(task => {
                // æ£€æŸ¥æ˜¯å¦å·²æ‰“å¡
                const hasCheckedIn = store.checkins.some(checkin => 
                    checkin.taskId === task.id && 
                    checkin.userId === store.currentUser.id && 
                    checkin.date === today
                );

                // æ£€æŸ¥æ—¶é—´èŒƒå›´
                const timeCheck = checkTimeRange(currentTime, task.expectedTime, task.timeRange);
                
                let statusHtml = '';
                let buttonHtml = '';
                
                if (hasCheckedIn) {
                    const checkin = store.checkins.find(c => 
                        c.taskId === task.id && 
                        c.userId === store.currentUser.id && 
                        c.date === today
                    );
                    statusHtml = `<div style="color: #27ae60; font-weight: 600; margin-top: 8px;">âœ… å·²æ‰“å¡ ${checkin.checkinTime}</div>`;
                    buttonHtml = `<button class="btn-small" style="background: #95a5a6; cursor: not-allowed;" disabled>å·²å®Œæˆ</button>`;
                } else {
                    if (timeCheck.inRange) {
                        statusHtml = `<div style="color: #27ae60; margin-top: 8px;">â° å¯ä»¥æ‰“å¡ (${timeCheck.startTime} - ${timeCheck.endTime})</div>`;
                        buttonHtml = `<button class="btn-small btn-checkin" onclick="checkinTask('${task.id}')">ç«‹å³æ‰“å¡</button>`;
                    } else {
                        statusHtml = `<div style="color: #e67e22; margin-top: 8px;">â° ä¸åœ¨æ‰“å¡æ—¶é—´ (${timeCheck.startTime} - ${timeCheck.endTime})</div>`;
                        buttonHtml = `<button class="btn-small btn-checkin" onclick="checkinTask('${task.id}')">å°è¯•æ‰“å¡</button>`;
                    }
                }
                
                return `
                    <div class="task-item">
                        <h4>${task.title}</h4>
                        <p>${task.description}</p>
                        <div class="task-meta">
                            <span>ç›®æ ‡æ—¶é—´: ${task.expectedTime}</span>
                            <span>å…è®¸èŒƒå›´: Â±${task.timeRange}åˆ†é’Ÿ</span>
                        </div>
                        ${statusHtml}
                        <div class="task-actions">
                            ${buttonHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function checkTimeRange(currentTime, expectedTime, timeRange) {
            const [currentHour, currentMinute] = currentTime.split(':').map(Number);
            const [expectedHour, expectedMinute] = expectedTime.split(':').map(Number);
            
            const currentMinutes = currentHour * 60 + currentMinute;
            const expectedMinutes = expectedHour * 60 + expectedMinute;
            
            const startMinutes = expectedMinutes - timeRange;
            const endMinutes = expectedMinutes + timeRange;
            
            const formatTime = (minutes) => {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
            };
            
            return {
                inRange: currentMinutes >= startMinutes && currentMinutes <= endMinutes,
                startTime: formatTime(Math.max(0, startMinutes)),
                endTime: formatTime(Math.min(1439, endMinutes)),
                currentTime,
                expectedTime
            };
        }

        function checkinTask(taskId) {
            const task = store.tasks.find(t => t.id === taskId);
            if (!task) {
                alert('ä»»åŠ¡ä¸å­˜åœ¨');
                return;
            }

            const today = getLocalDateStr();
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            // æ£€æŸ¥æ˜¯å¦åœ¨æ—¶é—´èŒƒå›´å†…
            const timeCheckResult = checkTimeRange(currentTime, task.expectedTime, task.timeRange);
            
            if (!timeCheckResult.inRange) {
                const message = `å½“å‰æ—¶é—´ ${currentTime} ä¸åœ¨å…è®¸çš„æ‰“å¡æ—¶é—´èŒƒå›´å†…ã€‚\nå…è®¸æ—¶é—´ï¼š${timeCheckResult.startTime} - ${timeCheckResult.endTime}`;
                alert(message);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ‰“è¿‡å¡
            const hasCheckedIn = store.checkins.some(checkin => 
                checkin.taskId === taskId && 
                checkin.userId === store.currentUser.id && 
                checkin.date === today
            );
            
            if (hasCheckedIn) {
                alert('ä»Šæ—¥å·²æ‰“å¡ï¼');
                return;
            }
            
            const checkinData = {
                id: Date.now().toString(),
                taskId,
                userId: store.currentUser.id,
                userName: store.currentUser.name,
                taskTitle: task.title,
                date: today,
                checkinTime: currentTime,
                expectedTime: task.expectedTime,
                status: 'completed',
                feedback: '',
                createdAt: Date.now()
            };
            
            store.checkins.push(checkinData);
            saveData();
            
            alert(`æ‰“å¡æˆåŠŸï¼æ—¶é—´ï¼š${currentTime}`);
            loadTodayTasks(); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
        }

        function deleteTask(taskId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }
            
            const taskIndex = store.tasks.findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                store.tasks[taskIndex].isActive = false;
                saveData();
                alert('ä»»åŠ¡åˆ é™¤æˆåŠŸï¼');
                loadTaskList(); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
            }
        }

        function showSetupMessage(message, type) {
            const messageDiv = document.getElementById('setupMessage');
            messageDiv.textContent = message;
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
        }

        function showLoginMessage(message, type) {
            const messageDiv = document.getElementById('loginMessage');
            messageDiv.textContent = message;
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
        }
    </script>
</body>
</html>