<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>å®¶åº­æ‰“å¡æé†’</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            padding-top: max(12px, env(safe-area-inset-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .app-header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        /* ç™»å½•é¡µé¢ */
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn, .register-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }

        .login-btn {
            background: #667eea;
            color: white;
        }

        .login-btn:hover {
            background: #5a6fd8;
        }

        .register-btn {
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .register-btn:hover {
            background: #667eea;
            color: white;
        }

        .error-message, .success-message {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            white-space: pre-line;
            line-height: 1.4;
        }

        .error-message {
            color: #e74c3c;
        }

        .success-message {
            color: #27ae60;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .page {
            display: none;
            height: 100%;
        }

        .page.active {
            display: block;
        }

        .tab-content {
            display: none;
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* è¡¨å•æ ·å¼ */
        .form-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-container h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .primary-btn {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .primary-btn:hover {
            background: #5a6fd8;
        }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .task-list-container h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .task-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .task-item h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
        }

        .task-item p {
            margin: 0 0 8px 0;
            color: #666;
            font-size: 14px;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #999;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-checkin {
            background: #27ae60;
            color: white;
        }

        /* æ—¥å†æ ·å¼ */
        .calendar-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .calendar-header button {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
        }

        .calendar-header h3 {
            color: #333;
            font-size: 18px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e1e5e9;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 12px 4px;
            text-align: center;
            font-size: 14px;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            color: #ccc;
            background: #f8f9fa;
        }

        .calendar-day.today {
            background: #667eea;
            color: white;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .calendar-tasks {
            font-size: 10px;
            color: #666;
        }

        .calendar-day.today .calendar-tasks {
            color: rgba(255, 255, 255, 0.8);
        }

        /* åº•éƒ¨å¯¼èˆª */
        .footer-nav {
            display: flex;
            background: white;
            border-top: 1px solid #e1e5e9;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .footer-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: none;
            border: none;
            color: #999;
            font-size: 12px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .footer-item.active {
            color: #667eea;
        }

        .footer-item-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .login-box {
                padding: 20px;
                margin: 10px;
            }
            
            .login-title {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2 class="login-title">å®¶åº­æ‰“å¡æé†’</h2>
            
            <!-- ç™»å½•è¡¨å• -->
            <div id="loginForm">
                <div class="form-group">
                    <label for="email">é‚®ç®±</label>
                    <input type="email" id="email" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" required>
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button id="loginBtn" class="login-btn">ç™»å½•</button>
                <button id="showRegisterBtn" class="register-btn">æ³¨å†Œæ–°è´¦æˆ·</button>
                <div id="authMessage"></div>
            </div>

            <!-- æ³¨å†Œè¡¨å• -->
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label for="regEmail">é‚®ç®±</label>
                    <input type="email" id="regEmail" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">å¯†ç </label>
                    <input type="password" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required>
                </div>
                <div class="form-group">
                    <label for="regName">å§“å</label>
                    <input type="text" id="regName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required>
                </div>
                <div class="form-group">
                    <label for="regRole">è§’è‰²</label>
                    <select id="regRole" required>
                        <option value="">è¯·é€‰æ‹©è§’è‰²</option>
                        <option value="admin">ç®¡ç†å‘˜ï¼ˆå¯ä»¥åˆ›å»ºå’Œç®¡ç†ä»»åŠ¡ï¼‰</option>
                        <option value="member">æˆå‘˜ï¼ˆå¯ä»¥æŸ¥çœ‹ä»»åŠ¡å’Œæ‰“å¡ï¼‰</option>
                    </select>
                </div>
                <button id="registerBtn" class="login-btn">æ³¨å†Œ</button>
                <button id="backToLoginBtn" class="register-btn">è¿”å›ç™»å½•</button>
                <div id="regMessage"></div>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div id="mainApp" class="app-container hidden">
        <div class="app-header">
            <h1>å®¶åº­æ‰“å¡æé†’</h1>
            <div class="user-info">
                <span id="currentUserEmail"></span>
                <button id="logoutBtn" class="logout-btn">é€€å‡º</button>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- ç®¡ç†å‘˜é¡µé¢ -->
            <div id="adminPage" class="page">
                <!-- æ–°å»ºä»»åŠ¡ -->
                <div id="adminCreateTab" class="tab-content active">
                    <div class="form-container">
                        <h3>æ–°å»ºä»»åŠ¡</h3>
                        <div class="form-group">
                            <label>ä»»åŠ¡æ ‡é¢˜</label>
                            <input type="text" id="taskTitle" placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜">
                        </div>
                        <div class="form-group">
                            <label>ä»»åŠ¡æè¿°</label>
                            <textarea id="taskDescription" placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="taskStartDate">
                        </div>
                        <div class="form-group">
                            <label>ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="taskEndDate">
                        </div>
                        <div class="form-group">
                            <label>é‡å¤å‘¨æœŸ</label>
                            <select id="taskCycle" onchange="toggleCustomDays()">
                                <option value="daily">æ¯å¤©</option>
                                <option value="weekly">æ¯å‘¨</option>
                                <option value="custom">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                        <div class="form-group" id="customDaysGroup" style="display: none;">
                            <label>è‡ªå®šä¹‰å¤©æ•°</label>
                            <input type="number" id="customDays" min="1" placeholder="é—´éš”å¤©æ•°">
                        </div>
                        <div class="form-group">
                            <label>ç›®æ ‡æ—¶é—´</label>
                            <input type="time" id="expectedTime">
                        </div>
                        <div class="form-group">
                            <label>å…è®¸æµ®åŠ¨æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" id="timeRange" min="0" placeholder="Â±åˆ†é’Ÿæ•°" value="30">
                        </div>
                        <button class="primary-btn" onclick="createTask()">åˆ›å»ºä»»åŠ¡</button>
                    </div>
                </div>

                <!-- ä»»åŠ¡ç®¡ç† -->
                <div id="adminManageTab" class="tab-content">
                    <div class="task-list-container">
                        <h3>ä»»åŠ¡ç®¡ç†</h3>
                        <div id="taskList"></div>
                    </div>
                </div>

                <!-- ç®¡ç†å‘˜æ—¥å† -->
                <div id="adminCalendarTab" class="tab-content">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button onclick="changeMonth(-1)">â€¹</button>
                            <h3 id="adminCalendarTitle"></h3>
                            <button onclick="changeMonth(1)">â€º</button>
                        </div>
                        <div id="adminCalendar" class="calendar"></div>
                    </div>
                </div>
            </div>

            <!-- æˆå‘˜é¡µé¢ -->
            <div id="memberPage" class="page">
                <!-- ä»Šæ—¥ä»»åŠ¡ -->
                <div id="memberTaskTab" class="tab-content active">
                    <div class="task-list-container">
                        <h3>ä»Šæ—¥ä»»åŠ¡</h3>
                        <div id="todayTasks"></div>
                    </div>
                </div>

                <!-- æˆå‘˜æ—¥å† -->
                <div id="memberCalendarTab" class="tab-content">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button onclick="changeMonth(-1)">â€¹</button>
                            <h3 id="memberCalendarTitle"></h3>
                            <button onclick="changeMonth(1)">â€º</button>
                        </div>
                        <div id="memberCalendar" class="calendar"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <div id="footerNav" class="footer-nav">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let currentUser = null;
        let currentUserProfile = null;
        let currentMonth = new Date();
        let currentAdminTab = 'create';
        let currentMemberTab = 'task';

        // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®åº“ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
        const userDatabase = {
            users: JSON.parse(localStorage.getItem('users') || '[]'),
            tasks: JSON.parse(localStorage.getItem('tasks') || '[]'),
            checkins: JSON.parse(localStorage.getItem('checkins') || '[]')
        };

        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveToStorage() {
            localStorage.setItem('users', JSON.stringify(userDatabase.users));
            localStorage.setItem('tasks', JSON.stringify(userDatabase.tasks));
            localStorage.setItem('checkins', JSON.stringify(userDatabase.checkins));
        }

        // è·å–æœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
        function getLocalDateStr(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('åº”ç”¨å¼€å§‹åˆå§‹åŒ–...');
            
            // ç»‘å®šç™»å½•äº‹ä»¶
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('showRegisterBtn').addEventListener('click', showRegisterForm);
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('backToLoginBtn').addEventListener('click', showLoginForm);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // å›è½¦é”®ç™»å½•
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // å›è½¦é”®æ³¨å†Œ
            document.getElementById('regPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleRegister();
                }
            });

            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            const today = new Date();
            document.getElementById('taskStartDate').value = getLocalDateStr(today);
            document.getElementById('taskEndDate').value = getLocalDateStr(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000));
        });

        // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('regMessage').textContent = '';
        }

        // æ˜¾ç¤ºç™»å½•è¡¨å•
        function showLoginForm() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('authMessage').textContent = '';
        }

        // å¤„ç†ç™»å½•
        function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showMessage('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            // æŸ¥æ‰¾ç”¨æˆ·
            const user = userDatabase.users.find(u => u.email === email);
            if (!user) {
                showMessage('ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                return;
            }

            if (user.password !== password) {
                showMessage('å¯†ç é”™è¯¯', 'error');
                return;
            }

            // ç™»å½•æˆåŠŸ
            currentUser = { uid: user.id, email: user.email };
            currentUserProfile = user;
            showMainApp();
        }

        // å¤„ç†æ³¨å†Œ
        function handleRegister() {
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value.trim();
            const role = document.getElementById('regRole').value;

            if (!email || !password || !name || !role) {
                showRegMessage('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }

            if (password.length < 6) {
                showRegMessage('å¯†ç è‡³å°‘éœ€è¦6ä½', 'error');
                return;
            }

            // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
            if (userDatabase.users.find(u => u.email === email)) {
                showRegMessage('é‚®ç®±å·²è¢«ä½¿ç”¨', 'error');
                return;
            }

            // åˆ›å»ºæ–°ç”¨æˆ·
            const newUser = {
                id: Date.now().toString(),
                email: email,
                password: password,
                name: name,
                role: role,
                createdAt: Date.now()
            };

            userDatabase.users.push(newUser);
            saveToStorage();

            showRegMessage('æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨ç™»å½•...', 'success');
            
            // è‡ªåŠ¨ç™»å½•
            setTimeout(() => {
                currentUser = { uid: newUser.id, email: newUser.email };
                currentUserProfile = newUser;
                showMainApp();
            }, 1000);
        }

        // å¤„ç†é€€å‡º
        function handleLogout() {
            currentUser = null;
            currentUserProfile = null;
            showLoginScreen();
        }

        // æ˜¾ç¤ºç™»å½•é¡µé¢
        function showLoginScreen() {
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // æ˜¾ç¤ºä¸»åº”ç”¨
        function showMainApp() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('currentUserEmail').textContent = currentUser.email;
            
            // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒé¡µé¢
            if (currentUserProfile.role === 'admin') {
                showPage('adminPage');
                setupAdminNav();
                switchAdminTab('create');
            } else {
                showPage('memberPage');
                setupMemberNav();
                switchMemberTab('task');
            }
        }

        // è®¾ç½®ç®¡ç†å‘˜å¯¼èˆª
        function setupAdminNav() {
            const footerNav = document.getElementById('footerNav');
            footerNav.innerHTML = `
                <button class="footer-item active" onclick="switchFooterTab('tab1')">
                    <div class="footer-item-icon">â•</div>
                    <div>æ–°å»º</div>
                </button>
                <button class="footer-item" onclick="switchFooterTab('tab2')">
                    <div class="footer-item-icon">ğŸ“‹</div>
                    <div>ç®¡ç†</div>
                </button>
                <button class="footer-item" onclick="switchFooterTab('tab3')">
                    <div class="footer-item-icon">ğŸ“…</div>
                    <div>æ—¥å†</div>
                </button>
            `;
        }

        // è®¾ç½®æˆå‘˜å¯¼èˆª
        function setupMemberNav() {
            const footerNav = document.getElementById('footerNav');
            footerNav.innerHTML = `
                <button class="footer-item active" onclick="switchFooterTab('tab1')">
                    <div class="footer-item-icon">ğŸ“‹</div>
                    <div>ä»»åŠ¡</div>
                </button>
                <button class="footer-item" onclick="switchFooterTab('tab2')">
                    <div class="footer-item-icon">ğŸ“…</div>
                    <div>æ—¥å†</div>
                </button>
            `;
        }

        // æ˜¾ç¤ºé¡µé¢
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // åº•éƒ¨å¯¼èˆªåˆ‡æ¢
        function switchFooterTab(tab) {
            const footerItems = document.querySelectorAll('.footer-item');
            footerItems.forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (currentUserProfile.role === 'admin') {
                if (tab === 'tab1') {
                    switchAdminTab('create');
                } else if (tab === 'tab2') {
                    switchAdminTab('manage');
                } else if (tab === 'tab3') {
                    switchAdminTab('calendar');
                }
            } else {
                if (tab === 'tab1') {
                    switchMemberTab('task');
                } else if (tab === 'tab2') {
                    switchMemberTab('calendar');
                }
            }
        }

        // ç®¡ç†å‘˜æ ‡ç­¾åˆ‡æ¢
        function switchAdminTab(tab) {
            currentAdminTab = tab;
            document.querySelectorAll('#adminPage .tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'create') {
                document.getElementById('adminCreateTab').classList.add('active');
            } else if (tab === 'manage') {
                document.getElementById('adminManageTab').classList.add('active');
                loadTaskList();
            } else if (tab === 'calendar') {
                document.getElementById('adminCalendarTab').classList.add('active');
                renderAdminCalendar();
            }
        }

        // æˆå‘˜æ ‡ç­¾åˆ‡æ¢
        function switchMemberTab(tab) {
            currentMemberTab = tab;
            document.querySelectorAll('#memberPage .tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'task') {
                document.getElementById('memberTaskTab').classList.add('active');
                loadTodayTasks();
            } else if (tab === 'calendar') {
                document.getElementById('memberCalendarTab').classList.add('active');
                renderMemberCalendar();
            }
        }

        // åˆ‡æ¢è‡ªå®šä¹‰å¤©æ•°æ˜¾ç¤º
        function toggleCustomDays() {
            const cycle = document.getElementById('taskCycle').value;
            const customDaysGroup = document.getElementById('customDaysGroup');
            customDaysGroup.style.display = cycle === 'custom' ? 'block' : 'none';
        }

        // åˆ›å»ºä»»åŠ¡
        function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const startDate = document.getElementById('taskStartDate').value;
            const endDate = document.getElementById('taskEndDate').value;
            const cycle = document.getElementById('taskCycle').value;
            const customDays = document.getElementById('customDays').value;
            const expectedTime = document.getElementById('expectedTime').value;
            const timeRange = parseInt(document.getElementById('timeRange').value) || 30;

            if (!title || !startDate || !endDate || !expectedTime) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }

            if (cycle === 'custom' && (!customDays || customDays < 1)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è‡ªå®šä¹‰å¤©æ•°');
                return;
            }

            const taskData = {
                id: Date.now().toString(),
                title,
                description,
                startDate,
                endDate,
                cycle,
                customDays: cycle === 'custom' ? parseInt(customDays) : null,
                expectedTime,
                timeRange,
                createdBy: currentUser.uid,
                createdAt: Date.now(),
                isActive: true
            };

            userDatabase.tasks.push(taskData);
            saveToStorage();

            alert('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼');
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('customDays').value = '';
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        function loadTaskList() {
            const tasks = userDatabase.tasks.filter(task => task.isActive);
            renderTaskList(tasks.reverse());
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTaskList(tasks) {
            const taskList = document.getElementById('taskList');
            
            if (tasks.length === 0) {
                taskList.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">æš‚æ— ä»»åŠ¡</div>';
                return;
            }

            taskList.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <h4>${task.title}</h4>
                    <p>${task.description}</p>
                    <div class="task-meta">
                        <span>${task.startDate} è‡³ ${task.endDate}</span>
                        <span>${task.expectedTime} (Â±${task.timeRange}åˆ†é’Ÿ)</span>
                    </div>
                    <div class="task-actions">
                        <button class="btn-small btn-delete" onclick="deleteTask('${task.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // åŠ è½½ä»Šæ—¥ä»»åŠ¡
        function loadTodayTasks() {
            const today = getLocalDateStr();
            const todayTasks = userDatabase.tasks.filter(task => 
                task.isActive && isTaskActiveOnDate(task, today)
            );
            renderTodayTasks(todayTasks);
        }

        // åˆ¤æ–­ä»»åŠ¡åœ¨æŒ‡å®šæ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
        function isTaskActiveOnDate(task, dateStr) {
            const date = new Date(dateStr);
            const startDate = new Date(task.startDate);
            const endDate = new Date(task.endDate);
            
            if (date < startDate || date > endDate) {
                return false;
            }
            
            if (task.cycle === 'daily') {
                return true;
            } else if (task.cycle === 'weekly') {
                const daysDiff = Math.floor((date - startDate) / (24 * 60 * 60 * 1000));
                return daysDiff % 7 === 0;
            } else if (task.cycle === 'custom') {
                const daysDiff = Math.floor((date - startDate) / (24 * 60 * 60 * 1000));
                return daysDiff % task.customDays === 0;
            }
            
            return false;
        }

        // æ¸²æŸ“ä»Šæ—¥ä»»åŠ¡
        function renderTodayTasks(tasks) {
            const todayTasks = document.getElementById('todayTasks');
            
            if (tasks.length === 0) {
                todayTasks.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">ä»Šæ—¥æ— ä»»åŠ¡</div>';
                return;
            }

            const today = getLocalDateStr();
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            todayTasks.innerHTML = tasks.map(task => {
                // æ£€æŸ¥æ˜¯å¦å·²æ‰“å¡
                const hasCheckedIn = userDatabase.checkins.some(checkin => 
                    checkin.taskId === task.id && 
                    checkin.userId === currentUser.uid && 
                    checkin.date === today
                );

                // æ£€æŸ¥æ—¶é—´èŒƒå›´
                const timeCheck = checkTimeRange(currentTime, task.expectedTime, task.timeRange);
                
                let statusHtml = '';
                let buttonHtml = '';
                
                if (hasCheckedIn) {
                    const checkin = userDatabase.checkins.find(c => 
                        c.taskId === task.id && 
                        c.userId === currentUser.uid && 
                        c.date === today
                    );
                    statusHtml = `<div style="color: #27ae60; font-weight: 600; margin-top: 8px;">âœ… å·²æ‰“å¡ ${checkin.checkinTime}</div>`;
                    buttonHtml = `<button class="btn-small" style="background: #95a5a6; cursor: not-allowed;" disabled>å·²å®Œæˆ</button>`;
                } else {
                    if (timeCheck.inRange) {
                        statusHtml = `<div style="color: #27ae60; margin-top: 8px;">â° å¯ä»¥æ‰“å¡ (${timeCheck.startTime} - ${timeCheck.endTime})</div>`;
                        buttonHtml = `<button class="btn-small btn-checkin" onclick="checkinTask('${task.id}')">ç«‹å³æ‰“å¡</button>`;
                    } else {
                        statusHtml = `<div style="color: #e67e22; margin-top: 8px;">â° ä¸åœ¨æ‰“å¡æ—¶é—´ (${timeCheck.startTime} - ${timeCheck.endTime})</div>`;
                        buttonHtml = `<button class="btn-small btn-checkin" onclick="checkinTask('${task.id}')">å°è¯•æ‰“å¡</button>`;
                    }
                }
                
                return `
                    <div class="task-item">
                        <h4>${task.title}</h4>
                        <p>${task.description}</p>
                        <div class="task-meta">
                            <span>ç›®æ ‡æ—¶é—´: ${task.expectedTime}</span>
                            <span>å…è®¸èŒƒå›´: Â±${task.timeRange}åˆ†é’Ÿ</span>
                        </div>
                        ${statusHtml}
                        <div class="task-actions">
                            ${buttonHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ£€æŸ¥æ—¶é—´èŒƒå›´
        function checkTimeRange(currentTime, expectedTime, timeRange) {
            const [currentHour, currentMinute] = currentTime.split(':').map(Number);
            const [expectedHour, expectedMinute] = expectedTime.split(':').map(Number);
            
            const currentMinutes = currentHour * 60 + currentMinute;
            const expectedMinutes = expectedHour * 60 + expectedMinute;
            
            const startMinutes = expectedMinutes - timeRange;
            const endMinutes = expectedMinutes + timeRange;
            
            const formatTime = (minutes) => {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
            };
            
            return {
                inRange: currentMinutes >= startMinutes && currentMinutes <= endMinutes,
                startTime: formatTime(Math.max(0, startMinutes)),
                endTime: formatTime(Math.min(1439, endMinutes)),
                currentTime,
                expectedTime
            };
        }

        // æ‰“å¡ä»»åŠ¡
        function checkinTask(taskId) {
            const task = userDatabase.tasks.find(t => t.id === taskId);
            if (!task) {
                alert('ä»»åŠ¡ä¸å­˜åœ¨');
                return;
            }

            const today = getLocalDateStr();
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            // æ£€æŸ¥æ˜¯å¦åœ¨æ—¶é—´èŒƒå›´å†…
            const timeCheckResult = checkTimeRange(currentTime, task.expectedTime, task.timeRange);
            
            if (!timeCheckResult.inRange) {
                const message = `å½“å‰æ—¶é—´ ${currentTime} ä¸åœ¨å…è®¸çš„æ‰“å¡æ—¶é—´èŒƒå›´å†…ã€‚\nå…è®¸æ—¶é—´ï¼š${timeCheckResult.startTime} - ${timeCheckResult.endTime}`;
                alert(message);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ‰“è¿‡å¡
            const hasCheckedIn = userDatabase.checkins.some(checkin => 
                checkin.taskId === taskId && 
                checkin.userId === currentUser.uid && 
                checkin.date === today
            );
            
            if (hasCheckedIn) {
                alert('ä»Šæ—¥å·²æ‰“å¡ï¼');
                return;
            }
            
            const checkinData = {
                id: Date.now().toString(),
                taskId,
                userId: currentUser.uid,
                userName: currentUserProfile.name,
                taskTitle: task.title,
                date: today,
                checkinTime: currentTime,
                expectedTime: task.expectedTime,
                status: 'completed',
                feedback: '',
                createdAt: Date.now()
            };
            
            userDatabase.checkins.push(checkinData);
            saveToStorage();
            
            alert(`æ‰“å¡æˆåŠŸï¼æ—¶é—´ï¼š${currentTime}`);
            loadTodayTasks(); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
        }

        // åˆ é™¤ä»»åŠ¡
        function deleteTask(taskId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }
            
            const taskIndex = userDatabase.tasks.findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                userDatabase.tasks[taskIndex].isActive = false;
                saveToStorage();
                alert('ä»»åŠ¡åˆ é™¤æˆåŠŸï¼');
                loadTaskList(); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
            }
        }

        // æ¸²æŸ“ç®¡ç†å‘˜æ—¥å†
        function renderAdminCalendar() {
            renderCalendar('adminCalendar', 'adminCalendarTitle', true);
        }

        // æ¸²æŸ“æˆå‘˜æ—¥å†
        function renderMemberCalendar() {
            renderCalendar('memberCalendar', 'memberCalendarTitle', false);
        }

        // æ¸²æŸ“æ—¥å†
        function renderCalendar(calendarId, titleId, isAdmin) {
            const calendar = document.getElementById(calendarId);
            const title = document.getElementById(titleId);
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            title.textContent = `${year}å¹´${month + 1}æœˆ`;
            
            // è·å–æœˆä»½çš„ç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // ç”Ÿæˆæ—¥å†æ ¼å­
            const days = [];
            const current = new Date(startDate);
            
            for (let i = 0; i < 42; i++) {
                const dateStr = getLocalDateStr(current);
                const isCurrentMonth = current.getMonth() === month;
                const isToday = dateStr === getLocalDateStr();
                
                days.push({
                    date: new Date(current),
                    dateStr,
                    isCurrentMonth,
                    isToday,
                    day: current.getDate()
                });
                
                current.setDate(current.getDate() + 1);
            }
            
            // æ¸²æŸ“æ—¥å†
            calendar.innerHTML = days.map(day => {
                const classes = ['calendar-day'];
                if (!day.isCurrentMonth) classes.push('other-month');
                if (day.isToday) classes.push('today');
                
                // è®¡ç®—å½“å¤©çš„ä»»åŠ¡æ•°é‡
                const dayTasks = userDatabase.tasks.filter(task => 
                    task.isActive && isTaskActiveOnDate(task, day.dateStr)
                );
                
                const taskText = dayTasks.length > 0 ? `${dayTasks.length}ä¸ªä»»åŠ¡` : '';
                
                return `
                    <div class="${classes.join(' ')}" onclick="onCalendarDayClick('${day.dateStr}', ${isAdmin})">
                        <div class="calendar-day-number">${day.day}</div>
                        <div class="calendar-tasks">${taskText}</div>
                    </div>
                `;
            }).join('');
        }

        // æ—¥å†æ—¥æœŸç‚¹å‡»
        function onCalendarDayClick(dateStr, isAdmin) {
            console.log('ç‚¹å‡»æ—¥æœŸ:', dateStr, 'ç®¡ç†å‘˜:', isAdmin);
            // TODO: å®ç°æ—¥æœŸç‚¹å‡»åŠŸèƒ½
        }

        // åˆ‡æ¢æœˆä»½
        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            
            if (currentUserProfile.role === 'admin' && currentAdminTab === 'calendar') {
                renderAdminCalendar();
            } else if (currentUserProfile.role === 'member' && currentMemberTab === 'calendar') {
                renderMemberCalendar();
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const messageDiv = document.getElementById('authMessage');
            messageDiv.textContent = message;
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
        }

        // æ˜¾ç¤ºæ³¨å†Œæ¶ˆæ¯
        function showRegMessage(message, type) {
            const messageDiv = document.getElementById('regMessage');
            messageDiv.textContent = message;
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
        }
    </script>
</body>
</html>